Vagrant.configure("2") do |config|
  config.vm.box = "almalinux/9"  # AlmaLinux 9 image
  config.vm.hostname = "almalinux-vm"
  config.vm.network "private_network", ip: "192.168.56.100"
  config.vm.provider "virtualbox" do |vb|
    vb.memory = "2048"
    vb.cpus = 2
  end
  config.vm.provision "shell", inline: <<-SHELL
    sudo systemctl enable --now sshd
    dnf install -y python3 python3-pip git
    pip3 install --upgrade pip

    # Copy source to a system path
    cp -r /vagrant /opt/chaostok
    chmod +x /opt/chaostok/run.py

    # Install requirements if any
    if [ -f /opt/chaostok/requirements.txt ]; then
      pip3 install -r /opt/chaostok/requirements.txt
    fi

    # Set up the service
    cp /opt/chaostok/chaos.service /etc/systemd/system/chaos.service
    systemctl daemon-reexec
    systemctl daemon-reload
    systemctl enable chaos.service
    systemctl start chaos.service
  SHELL
end
